{% extends "base.html" %}

{% block title %}Training Management - NodeA Federated Learning{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-brain me-2"></i>Training Management
        </h1>
    </div>
</div>

<!-- Training Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-play-circle me-2"></i>Training Controls
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn btn-success btn-lg w-100 mb-3" id="start-training-btn" onclick="startTraining()">
                            <i class="fas fa-play me-2"></i>Start Training
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-danger btn-lg w-100 mb-3" id="stop-training-btn" onclick="stopTraining()" disabled>
                            <i class="fas fa-stop me-2"></i>Stop Training
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-info btn-lg w-100 mb-3" onclick="refreshStatus()">
                            <i class="fas fa-sync me-2"></i>Refresh Status
                        </button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Training Status:</strong> <span id="training-status-display">{{ info.training_status.title() }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Training Configuration -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Training Configuration
                </h5>
            </div>
            <div class="card-body">
                <form id="training-config-form">
                    <div class="mb-3">
                        <label for="epochs" class="form-label">Epochs</label>
                        <input type="number" class="form-control" id="epochs" value="5" min="1" max="100">
                    </div>
                    <div class="mb-3">
                        <label for="batch-size" class="form-label">Batch Size</label>
                        <select class="form-select" id="batch-size">
                            <option value="4">4</option>
                            <option value="8">8</option>
                            <option value="16" selected>16</option>
                            <option value="32">32</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="learning-rate" class="form-label">Learning Rate</label>
                        <input type="number" class="form-control" id="learning-rate" value="0.001" step="0.0001" min="0.0001" max="0.1">
                    </div>
                    <div class="mb-3">
                        <label for="accuracy-threshold" class="form-label">Accuracy Threshold</label>
                        <input type="number" class="form-control" id="accuracy-threshold" value="0.7" step="0.01" min="0.1" max="1.0">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveConfig()">
                        <i class="fas fa-save me-2"></i>Save Configuration
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Training Progress
                </h5>
            </div>
            <div class="card-body">
                <div id="training-progress">
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>No training in progress</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Recent Training Results:</h6>
                    <div id="recent-results">
                        <p class="text-muted">No recent training results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Training Logs -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt me-2"></i>Training Logs
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs('training')">
                        <i class="fas fa-trash me-1"></i>Clear Logs
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="log-container" id="training-logs">
                    <div class="text-center text-muted">
                        <i class="fas fa-list fa-2x mb-2"></i>
                        <p>No training logs available</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Files After Training -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-code me-2"></i>Generated Model Files
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Size</th>
                                <th>Modified</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="model-files-table">
                            {% if info.model_files %}
                                {% for file in info.model_files %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-code me-2"></i>{{ file.name }}
                                    </td>
                                    <td>{{ "%.2f"|format(file.size / 1024 / 1024) }} MB</td>
                                    <td>{{ file.modified[:19] }}</td>
                                    <td>
                                        <span class="badge bg-success">Available</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="downloadModel('{{ file.name }}')">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="sendModel('{{ file.name }}')">
                                            <i class="fas fa-upload"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No model files found</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let trainingInterval;

// Auto-refresh training status every 2 seconds
setInterval(function() {
    updateTrainingStatus();
}, 2000);

function updateTrainingStatus() {
    $.get('/api/system_info', function(data) {
        const status = data.training_status;
        $('#training-status-display').text(status.charAt(0).toUpperCase() + status.slice(1));
        
        // Update button states
        if (status === 'running') {
            $('#start-training-btn').prop('disabled', true);
            $('#stop-training-btn').prop('disabled', false);
            $('#training-progress').html(`
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                        Training in Progress...
                    </div>
                </div>
                <p class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Training is running...</p>
            `);
        } else {
            $('#start-training-btn').prop('disabled', false);
            $('#stop-training-btn').prop('disabled', true);
            if (status === 'completed') {
                $('#training-progress').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>Training completed successfully!
                    </div>
                `);
            } else if (status === 'failed') {
                $('#training-progress').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>Training failed!
                    </div>
                `);
            } else {
                $('#training-progress').html(`
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>No training in progress</p>
                    </div>
                `);
            }
        }
    });
}

function startTraining() {
    $.post('/api/start_training', function(data) {
        if (data.success) {
            showAlert('success', data.message);
            updateTrainingStatus();
            refreshLogs();
        } else {
            showAlert('danger', data.message);
        }
    });
}

function stopTraining() {
    $.post('/api/stop_training', function(data) {
        if (data.success) {
            showAlert('warning', data.message);
            updateTrainingStatus();
        } else {
            showAlert('danger', data.message);
        }
    });
}

function refreshStatus() {
    updateTrainingStatus();
    showAlert('info', 'Status refreshed');
}

function saveConfig() {
    const config = {
        epochs: $('#epochs').val(),
        batch_size: $('#batch-size').val(),
        learning_rate: $('#learning-rate').val(),
        accuracy_threshold: $('#accuracy-threshold').val()
    };
    
    // Save to localStorage for now (in real implementation, save to server)
    localStorage.setItem('trainingConfig', JSON.stringify(config));
    showAlert('success', 'Configuration saved');
}

function loadConfig() {
    const config = JSON.parse(localStorage.getItem('trainingConfig') || '{}');
    if (config.epochs) $('#epochs').val(config.epochs);
    if (config.batch_size) $('#batch-size').val(config.batch_size);
    if (config.learning_rate) $('#learning-rate').val(config.learning_rate);
    if (config.accuracy_threshold) $('#accuracy-threshold').val(config.accuracy_threshold);
}

function refreshLogs() {
    // In a real implementation, fetch logs from server
    $('#training-logs').html(`
        <div class="text-center text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Refreshing logs...</p>
        </div>
    `);
    
    setTimeout(function() {
        $('#training-logs').html(`
            <div class="text-center text-muted">
                <i class="fas fa-list fa-2x mb-2"></i>
                <p>No training logs available</p>
            </div>
        `);
    }, 1000);
}

function clearLogs(type) {
    $.post('/api/clear_logs', {type: type}, function(data) {
        if (data.success) {
            showAlert('success', data.message);
            refreshLogs();
        } else {
            showAlert('danger', data.message);
        }
    });
}

function downloadModel(filename) {
    window.open('/api/download_model/' + filename, '_blank');
}

function sendModel(filename) {
    $.post('/api/send_model', function(data) {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.message);
        }
    });
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.container-fluid').prepend(alertHtml);
}

// Load configuration on page load
$(document).ready(function() {
    loadConfig();
    updateTrainingStatus();
});
</script>
{% endblock %}
