{% extends "base.html" %}

{% block title %}File Transfer - NodeA Federated Learning{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-exchange-alt me-2"></i>File Transfer Management
        </h1>
    </div>
</div>

<!-- Connection Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-network-wired me-2"></i>Connection Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>PoCL Server Connection</h6>
                                <p class="text-muted mb-0">Status: <span id="connection-status">{{ info.pocl_server_status }}</span></p>
                            </div>
                            <div>
                                <button class="btn btn-outline-primary" onclick="testConnection()">
                                    <i class="fas fa-network-wired me-2"></i>Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>Global Model Receiver</h6>
                                <p class="text-muted mb-0">Status: <span id="receiver-status">{{ info.receiver_status.title() }}</span></p>
                            </div>
                            <div>
                                <button class="btn btn-outline-success" id="receiver-toggle-btn" onclick="toggleReceiver()">
                                    <i class="fas fa-play me-2"></i>Start Receiver
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Send Model to PoCL -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>Send Model to PoCL Server
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="model-select" class="form-label">Select Model to Send</label>
                            <select class="form-select" id="model-select">
                                <option value="">Select a model...</option>
                                {% if info.model_files %}
                                    {% for file in info.model_files %}
                                    <option value="{{ file.name }}">{{ file.name }} ({{ "%.2f"|format(file.size / 1024 / 1024) }} MB)</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-metadata" checked>
                                <label class="form-check-label" for="include-metadata">
                                    Include metadata.json
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button class="btn btn-primary btn-lg" onclick="sendSelectedModel()">
                                <i class="fas fa-upload me-2"></i>Send Model
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="transfer-progress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">
                            Transferring...
                        </div>
                    </div>
                    <small class="text-muted">Sending model to PoCL server...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transfer History -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Transfer History
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearHistory()">
                        <i class="fas fa-trash me-1"></i>Clear History
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>File</th>
                                <th>Direction</th>
                                <th>Status</th>
                                <th>Size</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="transfer-history">
                            <tr>
                                <td colspan="6" class="text-center text-muted">No transfer history available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Global Model Receiver -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>Global Model Receiver
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Receiver Configuration</h6>
                        <div class="mb-3">
                            <label for="receiver-port" class="form-label">Port</label>
                            <input type="number" class="form-control" id="receiver-port" value="8889" min="1024" max="65535">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto-backup" checked>
                                <label class="form-check-label" for="auto-backup">
                                    Create backup before updating
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Receiver Status</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Status:</strong> <span id="receiver-status-display">{{ info.receiver_status.title() }}</span>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" id="start-receiver-btn" onclick="startReceiver()">
                                <i class="fas fa-play me-2"></i>Start Receiver
                            </button>
                            <button class="btn btn-danger" id="stop-receiver-btn" onclick="stopReceiver()" disabled>
                                <i class="fas fa-stop me-2"></i>Stop Receiver
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Logs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt me-2"></i>Transfer Logs
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearTransferLogs()">
                        <i class="fas fa-trash me-1"></i>Clear Logs
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshTransferLogs()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="log-container" id="transfer-logs">
                    <div class="text-center text-muted">
                        <i class="fas fa-list fa-2x mb-2"></i>
                        <p>No transfer logs available</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let transferHistory = JSON.parse(localStorage.getItem('transferHistory') || '[]');

// Auto-refresh status every 3 seconds
setInterval(function() {
    updateTransferStatus();
}, 3000);

function updateTransferStatus() {
    $.get('/api/system_info', function(data) {
        $('#connection-status').text(data.pocl_server_status);
        $('#receiver-status').text(data.receiver_status.charAt(0).toUpperCase() + data.receiver_status.slice(1));
        $('#receiver-status-display').text(data.receiver_status.charAt(0).toUpperCase() + data.receiver_status.slice(1));
        
        // Update receiver button states
        if (data.receiver_status === 'running') {
            $('#start-receiver-btn').prop('disabled', true);
            $('#stop-receiver-btn').prop('disabled', false);
            $('#receiver-toggle-btn').html('<i class="fas fa-stop me-2"></i>Stop Receiver');
            $('#receiver-toggle-btn').removeClass('btn-outline-success').addClass('btn-outline-danger');
        } else {
            $('#start-receiver-btn').prop('disabled', false);
            $('#stop-receiver-btn').prop('disabled', true);
            $('#receiver-toggle-btn').html('<i class="fas fa-play me-2"></i>Start Receiver');
            $('#receiver-toggle-btn').removeClass('btn-outline-danger').addClass('btn-outline-success');
        }
    });
}

function testConnection() {
    $.get('/api/test_connection', function(data) {
        if (data.success) {
            showAlert(data.connected ? 'success' : 'warning', data.message);
        } else {
            showAlert('danger', 'Connection test failed');
        }
    });
}

function sendSelectedModel() {
    const selectedModel = $('#model-select').val();
    const includeMetadata = $('#include-metadata').prop('checked');
    
    if (!selectedModel) {
        showAlert('warning', 'Please select a model to send');
        return;
    }
    
    $('#transfer-progress').show();
    
    $.post('/api/send_model', function(data) {
        $('#transfer-progress').hide();
        
        if (data.success) {
            showAlert('success', data.message);
            
            // Add to transfer history
            const historyEntry = {
                timestamp: new Date().toISOString(),
                file: selectedModel,
                direction: 'Upload',
                status: 'Success',
                size: 'N/A',
                duration: 'N/A'
            };
            transferHistory.unshift(historyEntry);
            if (transferHistory.length > 50) {
                transferHistory = transferHistory.slice(0, 50);
            }
            localStorage.setItem('transferHistory', JSON.stringify(transferHistory));
            updateTransferHistory();
        } else {
            showAlert('danger', data.message);
            
            // Add failed entry to history
            const historyEntry = {
                timestamp: new Date().toISOString(),
                file: selectedModel,
                direction: 'Upload',
                status: 'Failed',
                size: 'N/A',
                duration: 'N/A'
            };
            transferHistory.unshift(historyEntry);
            localStorage.setItem('transferHistory', JSON.stringify(transferHistory));
            updateTransferHistory();
        }
    });
}

function startReceiver() {
    $.post('/api/start_receiver', function(data) {
        if (data.success) {
            showAlert('success', data.message);
            updateTransferStatus();
        } else {
            showAlert('danger', data.message);
        }
    });
}

function stopReceiver() {
    $.post('/api/stop_receiver', function(data) {
        if (data.success) {
            showAlert('warning', data.message);
            updateTransferStatus();
        } else {
            showAlert('danger', data.message);
        }
    });
}

function toggleReceiver() {
    const receiverStatus = $('#receiver-status').text().toLowerCase();
    if (receiverStatus === 'running') {
        stopReceiver();
    } else {
        startReceiver();
    }
}

function updateTransferHistory() {
    const tbody = $('#transfer-history');
    if (transferHistory.length === 0) {
        tbody.html('<tr><td colspan="6" class="text-center text-muted">No transfer history available</td></tr>');
        return;
    }
    
    let html = '';
    transferHistory.forEach(function(entry) {
        const statusClass = entry.status === 'Success' ? 'success' : 'danger';
        html += `
            <tr>
                <td>${new Date(entry.timestamp).toLocaleString()}</td>
                <td>${entry.file}</td>
                <td>${entry.direction}</td>
                <td><span class="badge bg-${statusClass}">${entry.status}</span></td>
                <td>${entry.size}</td>
                <td>${entry.duration}</td>
            </tr>
        `;
    });
    tbody.html(html);
}

function clearHistory() {
    if (confirm('Are you sure you want to clear the transfer history?')) {
        transferHistory = [];
        localStorage.setItem('transferHistory', JSON.stringify(transferHistory));
        updateTransferHistory();
        showAlert('info', 'Transfer history cleared');
    }
}

function refreshTransferLogs() {
    $('#transfer-logs').html(`
        <div class="text-center text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Refreshing logs...</p>
        </div>
    `);
    
    setTimeout(function() {
        $('#transfer-logs').html(`
            <div class="text-center text-muted">
                <i class="fas fa-list fa-2x mb-2"></i>
                <p>No transfer logs available</p>
            </div>
        `);
    }, 1000);
}

function clearTransferLogs() {
    if (confirm('Are you sure you want to clear the transfer logs?')) {
        $('#transfer-logs').html(`
            <div class="text-center text-muted">
                <i class="fas fa-list fa-2x mb-2"></i>
                <p>No transfer logs available</p>
            </div>
        `);
        showAlert('info', 'Transfer logs cleared');
    }
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.container-fluid').prepend(alertHtml);
}

// Initialize page
$(document).ready(function() {
    updateTransferStatus();
    updateTransferHistory();
});
</script>
{% endblock %}
